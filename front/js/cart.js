let cartItems=JSON.parse(localStorage.getItem("products")||"[]"),productData=[];const productsLocation=document.getElementById("cart__items"),totalLocation=document.getElementById("totalPrice");function displayEmptyCart(){productsLocation.innerHTML="<p id='emptyCartMsg'>Votre panier est vide</p>",document.getElementById("emptyCartMsg").style.textAlign="center",document.querySelector(".cart__order").style.display="none"}async function fetchAndMergeProductData(){try{const t=await fetch("https://kanap-kue4.onrender.com/api/products");productData=await t.json(),cartItems=cartItems.map((t=>({...t,...productData.find((e=>e._id===t.id))})))}catch(t){console.error("An error occurred:",t)}}function calculateAndDisplayTotalPrice(){const t=cartItems.reduce(((t,e)=>t+e.price*e.quantity),0);totalLocation.textContent=`${t}`}function createCartItemElement(t){const e=document.createElement("article");e.className="cart__item",e.dataset.id=t.id,e.dataset.color=t.color;const a=document.createElement("div");a.className="cart__item__img";const r=document.createElement("img");r.src=t.imageUrl,r.alt=t.altTxt,a.appendChild(r);const n=document.createElement("div");n.className="cart__item__content";const o=document.createElement("div");o.className="cart__item__content__description";const c=document.createElement("h2");c.textContent=t.name;const s=document.createElement("p");s.textContent=t.color;const i=document.createElement("p");i.textContent=`${t.price} €`,o.appendChild(c),o.appendChild(s),o.appendChild(i);const d=document.createElement("div");d.className="cart__item__content__settings";const l=document.createElement("div");l.className="cart__item__content__settings__quantity";const m=document.createElement("p");m.textContent="Qté : ";const p=document.createElement("input");p.type="number",p.className="itemQuantity",p.name="itemQuantity",p.min="1",p.max="100",p.value=t.quantity,l.appendChild(m),l.appendChild(p);const u=document.createElement("div");u.className="cart__item__content__settings__delete";const y=document.createElement("p");return y.className="deleteItem",y.textContent="Supprimer",u.appendChild(y),d.appendChild(l),d.appendChild(u),n.appendChild(o),n.appendChild(d),e.appendChild(a),e.appendChild(n),e}function displayCartItems(){if(0===cartItems.length)return void displayEmptyCart();const t=document.createDocumentFragment();cartItems.forEach((e=>{const a=createCartItemElement(e);t.appendChild(a)})),productsLocation.appendChild(t),calculateAndDisplayTotalPrice()}async function initializeCart(){await fetchAndMergeProductData(),displayCartItems(),setupEventListeners()}function setupEventListeners(){productsLocation.addEventListener("change",(function(t){if(t.target.classList.contains("itemQuantity")){const e=t.target.value;updateQuantity(t.target.closest(".cart__item").dataset.id,t.target.closest(".cart__item").dataset.color,e)}})),productsLocation.addEventListener("click",(function(t){if(t.target.classList.contains("deleteItem")){removeItemFromCart(t.target.closest(".cart__item").dataset.id,t.target.closest(".cart__item").dataset.color)}}))}function updateQuantity(t,e,a){const r=cartItems.findIndex((a=>a.id===t&&a.color===e));-1!==r&&(cartItems[r].quantity=parseInt(a,10),localStorage.setItem("products",JSON.stringify(cartItems)),calculateAndDisplayTotalPrice())}function removeItemFromCart(t,e){cartItems=cartItems.filter((a=>!(a.id===t&&a.color===e))),cartItems.length>0?localStorage.setItem("products",JSON.stringify(cartItems)):(localStorage.removeItem("products"),displayEmptyCart()),calculateAndDisplayTotalPrice(),document.querySelector(`[data-id="${t}"][data-color="${e}"]`).remove()}initializeCart();const form=document.querySelector("form");function displayError(t,e,a){document.getElementById(t+"ErrorMsg").textContent=a?"":e}function validateFirstName(t){return t.length>48||!t.match(/^[a-zA-Z'-]*$/)?(displayError("firstName","Le prénom doit comporter moins de 48 caractères et ne peut contenir que des lettres, des apostrophes ou des tirets.",!1),!1):(displayError("firstName","",!0),!0)}function validateLastName(t){return t.length>47||!t.match(/^[a-zA-Z'-]*$/)?(displayError("lastName","Le nom doit comporter moins de 48 caractères et ne peut contenir que des lettres, des apostrophes ou des tirets.",!1),!1):(displayError("lastName","",!0),!0)}function validateAddress(t){return t.length>60||!t.match(/^[a-zA-Z0-9\s,'-éèàêûôîäëüöç]*$/)?(displayError("address","L'adresse doit comporter moins de 60 caractères et ne peut pas contenir de caractères spéciaux.",!1),!1):(displayError("address","",!0),!0)}function validateCity(t){return t.length<2||t.length>48||!t.match(/^[a-zA-Z\s'-]*$/)?(displayError("city","La ville doit comporter entre 2 et 48 caractères et ne peut contenir que des lettres, des apostrophes ou des tirets.",!1),!1):(displayError("city","",!0),!0)}function validateEmail(t){return t.match(/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/)?(displayError("email","",!0),!0):(displayError("email","L'email n'est pas valide.",!1),!1)}function handleFormSubmission(t){t.preventDefault();const e=form.elements.firstName.value,a=form.elements.lastName.value,r=form.elements.address.value,n=form.elements.city.value,o=form.elements.email.value;if(validateFirstName(e)&&validateLastName(a)&&validateAddress(r)&&validateCity(n)&&validateEmail(o)){const t={firstName:e,lastName:a,address:r,city:n,email:o},c={contact:t,products:cartItems.map((t=>t.id))};console.log("Form is valid",t),sendToServer(c)}else console.error("Form is invalid")}function sendToServer(t){fetch("https://kanap-kue4.onrender.com/api/products/order",{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}}).then((t=>{if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return t.json()})).then((t=>{const e=t.orderId;window.location.href=`./confirmation.html?orderId=${e}`})).catch((t=>{console.error("Error from catch",t),alert(`Error: ${t.message}`)}))}form.addEventListener("submit",handleFormSubmission);